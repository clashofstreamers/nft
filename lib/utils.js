"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.packCollectibleData = exports.petAttributes = exports.heroAttributes = exports.defaultAttributes = exports.mockExtraAttributes = exports.toStringHex = exports.toNumberHex = exports.mockAttributes = exports.mockPetAttributes = exports.mockHeroAttributes = exports.createSignedBoostedKillMessage = exports.createSignedBoostedMergeMessage = exports.createSignedBoostedEmpowerMessage = exports.createSignedBoostedSendMessage = void 0;
const types_1 = require("./types");
const utils_1 = require("@prps/solidity/lib/utils");
const types_2 = require("@prps/solidity/lib/types");
const test_helpers_1 = require("@openzeppelin/test-helpers");
const eth_sig_util_1 = require("eth-sig-util");
exports.createSignedBoostedSendMessage = async (web3, { from, to, tokenId, nonce, timestamp, fuel, booster, isLegacySignature, verifyingContract, signer: { privateKey } }) => {
    var _a, _b, _c, _d;
    const typedData = {
        types: {
            EIP712Domain: types_2.EIP712Domain,
            BoostedSend: types_1.BoostedSend,
            BoosterFuel: types_2.BoosterFuel,
            BoosterPayload: types_2.BoosterPayload,
        },
        domain: utils_1.createEIP712Domain("Clash Of Streamers", verifyingContract),
        primaryType: "BoostedSend",
        message: {
            tag: types_1.BoostTag.Transfer,
            from,
            to,
            tokenId: tokenId.toString(),
            fuel: {
                dubi: ((_a = fuel === null || fuel === void 0 ? void 0 : fuel.dubi) !== null && _a !== void 0 ? _a : 0).toString(),
                unlockedPrps: ((_b = fuel === null || fuel === void 0 ? void 0 : fuel.unlockedPrps) !== null && _b !== void 0 ? _b : 0).toString(),
                lockedPrps: ((_c = fuel === null || fuel === void 0 ? void 0 : fuel.lockedPrps) !== null && _c !== void 0 ? _c : 0).toString(),
                intrinsicFuel: ((_d = fuel === null || fuel === void 0 ? void 0 : fuel.intrinsicFuel) !== null && _d !== void 0 ? _d : 0).toString(),
            },
            boosterPayload: {
                booster,
                timestamp: timestamp !== null && timestamp !== void 0 ? timestamp : await utils_1.blockchainTimestampWithOffset(web3, 0),
                nonce: nonce.toString(),
                isLegacySignature: (isLegacySignature || false),
            }
        }
    };
    return {
        message: typedData.message,
        signature: utils_1.signEIP712(typedData, { privateKey }),
        messageBytes: utils_1.getTypedMessageBytes(web3, typedData),
        messageHash: `0x${eth_sig_util_1.TypedDataUtils.sign(typedData).toString("hex")}`,
    };
};
exports.createSignedBoostedEmpowerMessage = async (web3, { funder, tokenId, amount, nonce, timestamp, fuel, booster, isLegacySignature, verifyingContract, signer: { privateKey } }) => {
    var _a, _b, _c, _d;
    const typedData = {
        types: {
            EIP712Domain: types_2.EIP712Domain,
            BoostedEmpower: types_1.BoostedEmpower,
            BoosterFuel: types_2.BoosterFuel,
            BoosterPayload: types_2.BoosterPayload,
        },
        domain: utils_1.createEIP712Domain("Clash Of Streamers", verifyingContract),
        primaryType: "BoostedEmpower",
        message: {
            tag: types_1.BoostTag.Empower,
            funder,
            tokenId: tokenId.toString(),
            amount: amount.toString(),
            fuel: {
                dubi: ((_a = fuel === null || fuel === void 0 ? void 0 : fuel.dubi) !== null && _a !== void 0 ? _a : 0).toString(),
                unlockedPrps: ((_b = fuel === null || fuel === void 0 ? void 0 : fuel.unlockedPrps) !== null && _b !== void 0 ? _b : 0).toString(),
                lockedPrps: ((_c = fuel === null || fuel === void 0 ? void 0 : fuel.lockedPrps) !== null && _c !== void 0 ? _c : 0).toString(),
                intrinsicFuel: ((_d = fuel === null || fuel === void 0 ? void 0 : fuel.intrinsicFuel) !== null && _d !== void 0 ? _d : 0).toString(),
            },
            boosterPayload: {
                booster,
                timestamp: timestamp !== null && timestamp !== void 0 ? timestamp : await utils_1.blockchainTimestampWithOffset(web3, 0),
                nonce: nonce.toString(),
                isLegacySignature: (isLegacySignature || false),
            }
        }
    };
    return {
        message: typedData.message,
        signature: utils_1.signEIP712(typedData, { privateKey }),
        messageBytes: utils_1.getTypedMessageBytes(web3, typedData),
        messageHash: `0x${eth_sig_util_1.TypedDataUtils.sign(typedData).toString("hex")}`,
    };
};
exports.createSignedBoostedMergeMessage = async (web3, { tokenIdSource, tokenIdTarget, nonce, timestamp, fuel, booster, isLegacySignature, verifyingContract, signer: { privateKey } }) => {
    var _a, _b, _c, _d;
    const typedData = {
        types: {
            EIP712Domain: types_2.EIP712Domain,
            BoostedMerge: types_1.BoostedMerge,
            BoosterFuel: types_2.BoosterFuel,
            BoosterPayload: types_2.BoosterPayload,
        },
        domain: utils_1.createEIP712Domain("Clash Of Streamers", verifyingContract),
        primaryType: "BoostedMerge",
        message: {
            tag: types_1.BoostTag.Merge,
            tokenIdSource: tokenIdSource.toString(),
            tokenIdTarget: tokenIdTarget.toString(),
            fuel: {
                dubi: ((_a = fuel === null || fuel === void 0 ? void 0 : fuel.dubi) !== null && _a !== void 0 ? _a : 0).toString(),
                unlockedPrps: ((_b = fuel === null || fuel === void 0 ? void 0 : fuel.unlockedPrps) !== null && _b !== void 0 ? _b : 0).toString(),
                lockedPrps: ((_c = fuel === null || fuel === void 0 ? void 0 : fuel.lockedPrps) !== null && _c !== void 0 ? _c : 0).toString(),
                intrinsicFuel: ((_d = fuel === null || fuel === void 0 ? void 0 : fuel.intrinsicFuel) !== null && _d !== void 0 ? _d : 0).toString(),
            },
            boosterPayload: {
                booster,
                timestamp: timestamp !== null && timestamp !== void 0 ? timestamp : await utils_1.blockchainTimestampWithOffset(web3, 0),
                nonce: nonce.toString(),
                isLegacySignature: (isLegacySignature || false),
            }
        }
    };
    return {
        message: typedData.message,
        signature: utils_1.signEIP712(typedData, { privateKey }),
        messageBytes: utils_1.getTypedMessageBytes(web3, typedData),
        messageHash: `0x${eth_sig_util_1.TypedDataUtils.sign(typedData).toString("hex")}`,
    };
};
exports.createSignedBoostedKillMessage = async (web3, { tokenId, nonce, timestamp, fuel, booster, isLegacySignature, verifyingContract, signer: { privateKey } }) => {
    var _a, _b, _c, _d;
    const typedData = {
        types: {
            EIP712Domain: types_2.EIP712Domain,
            BoostedKill: types_1.BoostedKill,
            BoosterFuel: types_2.BoosterFuel,
            BoosterPayload: types_2.BoosterPayload,
        },
        domain: utils_1.createEIP712Domain("Clash Of Streamers", verifyingContract),
        primaryType: "BoostedKill",
        message: {
            tag: types_1.BoostTag.Kill,
            tokenId: tokenId.toString(),
            fuel: {
                dubi: ((_a = fuel === null || fuel === void 0 ? void 0 : fuel.dubi) !== null && _a !== void 0 ? _a : 0).toString(),
                unlockedPrps: ((_b = fuel === null || fuel === void 0 ? void 0 : fuel.unlockedPrps) !== null && _b !== void 0 ? _b : 0).toString(),
                lockedPrps: ((_c = fuel === null || fuel === void 0 ? void 0 : fuel.lockedPrps) !== null && _c !== void 0 ? _c : 0).toString(),
                intrinsicFuel: ((_d = fuel === null || fuel === void 0 ? void 0 : fuel.intrinsicFuel) !== null && _d !== void 0 ? _d : 0).toString(),
            },
            boosterPayload: {
                booster,
                timestamp: timestamp !== null && timestamp !== void 0 ? timestamp : await utils_1.blockchainTimestampWithOffset(web3, 0),
                nonce: nonce.toString(),
                isLegacySignature: (isLegacySignature || false),
            }
        }
    };
    return {
        message: typedData.message,
        signature: utils_1.signEIP712(typedData, { privateKey }),
        messageBytes: utils_1.getTypedMessageBytes(web3, typedData),
        messageHash: `0x${eth_sig_util_1.TypedDataUtils.sign(typedData).toString("hex")}`,
    };
};
exports.mockHeroAttributes = (attributes) => ({ ...exports.heroAttributes, ...attributes });
exports.mockPetAttributes = (attributes) => ({ ...exports.petAttributes, ...attributes });
exports.mockAttributes = (attributes) => ({ ...exports.defaultAttributes, ...attributes });
exports.toNumberHex = (input) => `0x${input.toString(16).padStart(64, "0")}`;
exports.toStringHex = (input) => `0x${Buffer.from(input).toString("hex").padEnd(64, "0")}`;
exports.mockExtraAttributes = (attributes) => {
    const keys = [];
    const values = [];
    for (const [key, value] of Object.entries({ ...exports.defaultAttributes, ...attributes })) {
        keys.push(exports.toStringHex(key));
        values.push(typeof value === "string" ? exports.toStringHex(value) : exports.toNumberHex(value));
    }
    return {
        keys,
        values,
    };
};
exports.defaultAttributes = {
    level: 1,
    stars: 2,
    faction: 3,
    abilities: 1234,
    season: 9,
};
exports.heroAttributes = {
    ...exports.defaultAttributes,
    headIdAlias: "88",
    skinSlot: 1,
    skinDivision: 12,
    class: 3,
};
exports.petAttributes = {
    ...exports.defaultAttributes,
    headIdAlias: "123",
    shinyHue: 255,
};
exports.packCollectibleData = (contract, deployment, attributes) => {
    // We need to pack the attributes into a uint256
    const packedData = new test_helpers_1.BN(0);
    let offset = 0;
    // 24 bit headId
    packedData.ior(new test_helpers_1.BN(attributes.headIdAlias));
    offset += 24;
    // 96 bit empoweredDUBI
    packedData.ior(new test_helpers_1.BN(attributes.empoweredDUBI).shln(offset));
    offset += 96;
    // 32 bit season
    packedData.ior(new test_helpers_1.BN(attributes.season).shln(offset));
    offset += 32;
    // 32 bit abilities
    packedData.ior(new test_helpers_1.BN(attributes.abilities).shln(offset));
    offset += 32;
    // 8 bit stars
    packedData.ior(new test_helpers_1.BN(attributes.stars).shln(offset));
    offset += 8;
    // 8 bit level
    packedData.ior(new test_helpers_1.BN(attributes.level).shln(offset));
    offset += 8;
    // 4 bit faction
    // Since it is stored in a uint8 AND it with a bitmask where the first 4 bits are 1
    packedData.ior(new test_helpers_1.BN(attributes.faction).shln(offset));
    offset += 4;
    // Skip 2 bits for the flags which are 0 by default
    if (attributes.isFraud) {
        packedData.ior(new test_helpers_1.BN(1).shln(offset + 0));
    }
    if (attributes.hasDependentOp) {
        packedData.ior(new test_helpers_1.BN(1).shln(offset + 1));
    }
    offset += 2;
    if (contract.address === deployment.Heroes.address) {
        // 24 bit skinDvision
        packedData.ior(new test_helpers_1.BN(attributes.skinDivision).shln(offset));
        offset += 24;
        // 16 bit skinSlot
        packedData.ior(new test_helpers_1.BN(attributes.skinSlot).shln(offset));
        offset += 16;
        // 4 bit class
        packedData.ior(new test_helpers_1.BN(attributes.class).shln(offset));
        offset += 4;
    }
    else {
        // 8 bit shinyHue
        packedData.ior(new test_helpers_1.BN(attributes.shinyHue).shln(offset));
        offset += 8;
    }
    return packedData;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQTJGO0FBQzNGLG9EQUErSDtBQUMvSCxvREFBMEc7QUFDMUcsNkRBQWdEO0FBQ2hELCtDQUE4QztBQUVqQyxRQUFBLDhCQUE4QixHQUFHLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxFQUFFLEVBQUUsVUFBVSxFQUFFLEVBQW9RLEVBQWdDLEVBQUU7O0lBQy9jLE1BQU0sU0FBUyxHQUFHO1FBQ2QsS0FBSyxFQUFFO1lBQ0gsWUFBWSxFQUFaLG9CQUFZO1lBQ1osV0FBVyxFQUFYLG1CQUFXO1lBQ1gsV0FBVyxFQUFYLG1CQUFXO1lBQ1gsY0FBYyxFQUFkLHNCQUFjO1NBQ1Y7UUFDUixNQUFNLEVBQUUsMEJBQWtCLENBQUMsb0JBQW9CLEVBQUUsaUJBQWlCLENBQUM7UUFDbkUsV0FBVyxFQUFFLGFBQWE7UUFDMUIsT0FBTyxFQUFFO1lBQ0wsR0FBRyxFQUFFLGdCQUFRLENBQUMsUUFBUTtZQUN0QixJQUFJO1lBQ0osRUFBRTtZQUNGLE9BQU8sRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFO1lBQzNCLElBQUksRUFBRTtnQkFDRixJQUFJLEVBQUUsT0FBQyxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsSUFBSSxtQ0FBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUU7Z0JBQ2xDLFlBQVksRUFBRSxPQUFDLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxZQUFZLG1DQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRTtnQkFDbEQsVUFBVSxFQUFFLE9BQUMsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLFVB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Q0QsSUFBSSxVQUFVLENBQUMsY0FBYyxFQUFFO1FBQzNCLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxpQkFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUM3QztJQUNELE1BQU0sSUFBSSxDQUFDLENBQUM7SUFFWixJQUFJLFFBQVEsQ0FBQyxPQUFPLEtBQUssVUFBVSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7UUFDaEQscUJBQXFCO1FBQ3JCLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxpQkFBRSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUM3RCxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ2Isa0JBQWtCO1FBQ2xCLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxpQkFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUN6RCxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ2IsY0FBYztRQUNkLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxpQkFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUN0RCxNQUFNLElBQUksQ0FBQyxDQUFDO0tBQ2Y7U0FBTTtRQUNILGlCQUFpQjtRQUNqQixVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksaUJBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDekQsTUFBTSxJQUFJLENBQUMsQ0FBQztLQUNmO0lBRUQsT0FBTyxVQUFVLENBQUM7QUFDdEIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9vc3RUYWcsIEJvb3N0ZWRTZW5kLCBCb29zdGVkRW1wb3dlciwgQm9vc3RlZEtpbGwsIEJvb3N0ZWRNZXJnZSB9IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgeyBjcmVhdGVFSVA3MTJEb21haW4sIGJsb2NrY2hhaW5UaW1lc3RhbXBXaXRoT2Zmc2V0LCBzaWduRUlQNzEyLCBnZXRUeXBlZE1lc3NhZ2VCeXRlcyB9IGZyb20gXCJAcHJwcy9zb2xpZGl0eS9saWIvdXRpbHNcIjtcbmltcG9ydCB7IEVJUDcxMkRvbWFpbiwgQm9vc3RlckZ1ZWwsIEJvb3N0ZXJQYXlsb2FkLCBFSVA3MTJTaWduZWRNZXNzYWdlIH0gZnJvbSBcIkBwcnBzL3NvbGlkaXR5L2xpYi90eXBlc1wiO1xuaW1wb3J0IHsgQk4gfSBmcm9tIFwiQG9wZW56ZXBwZWxpbi90ZXN0LWhlbHBlcnNcIjtcbmltcG9ydCB7IFR5cGVkRGF0YVV0aWxzIH0gZnJvbSBcImV0aC1zaWctdXRpbFwiO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlU2lnbmVkQm9vc3RlZFNlbmRNZXNzYWdlID0gYXN5bmMgKHdlYjMsIHsgZnJvbSwgdG8sIHRva2VuSWQsIG5vbmNlLCB0aW1lc3RhbXAsIGZ1ZWwsIGJvb3N0ZXIsIGlzTGVnYWN5U2lnbmF0dXJlLCB2ZXJpZnlpbmdDb250cmFjdCwgc2lnbmVyOiB7IHByaXZhdGVLZXkgfSB9OiB7IGZyb206IHN0cmluZzsgdG86IHN0cmluZzsgdG9rZW5JZDogQk47IG5vbmNlOiBCTjsgaXNMZWdhY3lTaWduYXR1cmU/OiBib29sZWFuOyB0aW1lc3RhbXA/OiBudW1iZXIsIGZ1ZWw/OiB7IGR1Ymk/OiBCTiwgdW5sb2NrZWRQcnBzPzogQk4sIGxvY2tlZFBycHM/OiBCTiwgaW50cmluc2ljRnVlbD86IEJOIH0sIGJvb3N0ZXI6IHN0cmluZywgdmVyaWZ5aW5nQ29udHJhY3Q6IHN0cmluZywgc2lnbmVyOiB7IHByaXZhdGVLZXk6IHN0cmluZyB9OyB9KTogUHJvbWlzZTxFSVA3MTJTaWduZWRNZXNzYWdlPiA9PiB7XG4gICAgY29uc3QgdHlwZWREYXRhID0ge1xuICAgICAgICB0eXBlczoge1xuICAgICAgICAgICAgRUlQNzEyRG9tYWluLFxuICAgICAgICAgICAgQm9vc3RlZFNlbmQsXG4gICAgICAgICAgICBCb29zdGVyRnVlbCxcbiAgICAgICAgICAgIEJvb3N0ZXJQYXlsb2FkLFxuICAgICAgICB9IGFzIGFueSxcbiAgICAgICAgZG9tYWluOiBjcmVhdGVFSVA3MTJEb21haW4oXCJDbGFzaCBPZiBTdHJlYW1lcnNcIiwgdmVyaWZ5aW5nQ29udHJhY3QpLFxuICAgICAgICBwcmltYXJ5VHlwZTogXCJCb29zdGVkU2VuZFwiLFxuICAgICAgICBtZXNzYWdlOiB7XG4gICAgICAgICAgICB0YWc6IEJvb3N0VGFnLlRyYW5zZmVyLFxuICAgICAgICAgICAgZnJvbSxcbiAgICAgICAgICAgIHRvLFxuICAgICAgICAgICAgdG9rZW5JZDogdG9rZW5JZC50b1N0cmluZygpLFxuICAgICAgICAgICAgZnVlbDoge1xuICAgICAgICAgICAgICAgIGR1Ymk6IChmdWVsPy5kdWJpID8/IDApLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgdW5sb2NrZWRQcnBzOiAoZnVlbD8udW5sb2NrZWRQcnBzID8/IDApLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgbG9ja2VkUHJwczogKGZ1ZWw/LmxvY2tlZFBycHMgPz8gMCkudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICBpbnRyaW5zaWNGdWVsOiAoZnVlbD8uaW50cmluc2ljRnVlbCA/PyAwKS50b1N0cmluZygpLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJvb3N0ZXJQYXlsb2FkOiB7XG4gICAgICAgICAgICAgICAgYm9vc3RlcixcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IHRpbWVzdGFtcCA/PyBhd2FpdCBibG9ja2NoYWluVGltZXN0YW1wV2l0aE9mZnNldCh3ZWIzLCAwKSxcbiAgICAgICAgICAgICAgICBub25jZTogbm9uY2UudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICBpc0xlZ2FjeVNpZ25hdHVyZTogKGlzTGVnYWN5U2lnbmF0dXJlIHx8IGZhbHNlKSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBtZXNzYWdlOiB0eXBlZERhdGEubWVzc2FnZSxcbiAgICAgICAgc2lnbmF0dXJlOiBzaWduRUlQNzEyKHR5cGVkRGF0YSwgeyBwcml2YXRlS2V5IH0pLFxuICAgICAgICBtZXNzYWdlQnl0ZXM6IGdldFR5cGVkTWVzc2FnZUJ5dGVzKHdlYjMsIHR5cGVkRGF0YSksXG4gICAgICAgIG1lc3NhZ2VIYXNoOiBgMHgke1R5cGVkRGF0YVV0aWxzLnNpZ24odHlwZWREYXRhKS50b1N0cmluZyhcImhleFwiKX1gLFxuICAgIH07XG59XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVTaWduZWRCb29zdGVkRW1wb3dlck1lc3NhZ2UgPSBhc3luYyAod2ViMywgeyBmdW5kZXIsIHRva2VuSWQsIGFtb3VudCwgbm9uY2UsIHRpbWVzdGFtcCwgZnVlbCwgYm9vc3RlciwgaXNMZWdhY3lTaWduYXR1cmUsIHZlcmlmeWluZ0NvbnRyYWN0LCBzaWduZXI6IHsgcHJpdmF0ZUtleSB9IH06IHsgZnVuZGVyOiBzdHJpbmc7IHRva2VuSWQ6IHN0cmluZzsgYW1vdW50OiBCTjsgaXNMZWdhY3lTaWduYXR1cmU/OiBib29sZWFuOyBub25jZTogQk47IHRpbWVzdGFtcD86IG51bWJlciwgZnVlbD86IHsgZHViaT86IEJOLCB1bmxvY2tlZFBycHM/OiBCTiwgbG9ja2VkUHJwcz86IEJOLCBpbnRyaW5zaWNGdWVsPzogQk4gfSwgYm9vc3Rlcjogc3RyaW5nLCB2ZXJpZnlpbmdDb250cmFjdDogc3RyaW5nLCBzaWduZXI6IHsgcHJpdmF0ZUtleTogc3RyaW5nIH07IH0pOiBQcm9taXNlPEVJUDcxMlNpZ25lZE1lc3NhZ2U+ID0+IHtcbiAgICBjb25zdCB0eXBlZERhdGEgPSB7XG4gICAgICAgIHR5cGVzOiB7XG4gICAgICAgICAgICBFSVA3MTJEb21haW4sXG4gICAgICAgICAgICBCb29zdGVkRW1wb3dlcixcbiAgICAgICAgICAgIEJvb3N0ZXJGdWVsLFxuICAgICAgICAgICAgQm9vc3RlclBheWxvYWQsXG4gICAgICAgIH0gYXMgYW55LFxuICAgICAgICBkb21haW46IGNyZWF0ZUVJUDcxMkRvbWFpbihcIkNsYXNoIE9mIFN0cmVhbWVyc1wiLCB2ZXJpZnlpbmdDb250cmFjdCksXG4gICAgICAgIHByaW1hcnlUeXBlOiBcIkJvb3N0ZWRFbXBvd2VyXCIsXG4gICAgICAgIG1lc3NhZ2U6IHtcbiAgICAgICAgICAgIHRhZzogQm9vc3RUYWcuRW1wb3dlcixcbiAgICAgICAgICAgIGZ1bmRlcixcbiAgICAgICAgICAgIHRva2VuSWQ6IHRva2VuSWQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIGFtb3VudDogYW1vdW50LnRvU3RyaW5nKCksXG4gICAgICAgICAgICBmdWVsOiB7XG4gICAgICAgICAgICAgICAgZHViaTogKGZ1ZWw/LmR1YmkgPz8gMCkudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICB1bmxvY2tlZFBycHM6IChmdWVsPy51bmxvY2tlZFBycHMgPz8gMCkudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICBsb2NrZWRQcnBzOiAoZnVlbD8ubG9ja2VkUHJwcyA/PyAwKS50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgIGludHJpbnNpY0Z1ZWw6IChmdWVsPy5pbnRyaW5zaWNGdWVsID8/IDApLnRvU3RyaW5nKCksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYm9vc3RlclBheWxvYWQ6IHtcbiAgICAgICAgICAgICAgICBib29zdGVyLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogdGltZXN0YW1wID8/IGF3YWl0IGJsb2NrY2hhaW5UaW1lc3RhbXBXaXRoT2Zmc2V0KHdlYjMsIDApLFxuICAgICAgICAgICAgICAgIG5vbmNlOiBub25jZS50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgIGlzTGVnYWN5U2lnbmF0dXJlOiAoaXNMZWdhY3lTaWduYXR1cmUgfHwgZmFsc2UpLFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIG1lc3NhZ2U6IHR5cGVkRGF0YS5tZXNzYWdlLFxuICAgICAgICBzaWduYXR1cmU6IHNpZ25FSVA3MTIodHlwZWREYXRhLCB7IHByaXZhdGVLZXkgfSksXG4gICAgICAgIG1lc3NhZ2VCeXRlczogZ2V0VHlwZWRNZXNzYWdlQnl0ZXMod2ViMywgdHlwZWREYXRhKSxcbiAgICAgICAgbWVzc2FnZUhhc2g6IGAweCR7VHlwZWREYXRhVXRpbHMuc2lnbih0eXBlZERhdGEpLnRvU3RyaW5nKFwiaGV4XCIpfWAsXG4gICAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IGNyZWF0ZVNpZ25lZEJvb3N0ZWRNZXJnZU1lc3NhZ2UgPSBhc3luYyAod2ViMywgeyB0b2tlbklkU291cmNlLCB0b2tlbklkVGFyZ2V0LCBub25jZSwgdGltZXN0YW1wLCBmdWVsLCBib29zdGVyLCBpc0xlZ2FjeVNpZ25hdHVyZSwgdmVyaWZ5aW5nQ29udHJhY3QsIHNpZ25lcjogeyBwcml2YXRlS2V5IH0gfTogeyB0b2tlbklkU291cmNlOiBzdHJpbmc7IHRva2VuSWRUYXJnZXQ6IHN0cmluZzsgbm9uY2U6IEJOOyB0aW1lc3RhbXA/OiBudW1iZXIsIGlzTGVnYWN5U2lnbmF0dXJlPzogYm9vbGVhbjsgZnVlbD86IHsgZHViaT86IEJOLCB1bmxvY2tlZFBycHM/OiBCTiwgbG9ja2VkUHJwcz86IEJOLCBpbnRyaW5zaWNGdWVsPzogQk4gfSwgYm9vc3Rlcjogc3RyaW5nLCB2ZXJpZnlpbmdDb250cmFjdDogc3RyaW5nLCBzaWduZXI6IHsgcHJpdmF0ZUtleTogc3RyaW5nIH07IH0pOiBQcm9taXNlPEVJUDcxMlNpZ25lZE1lc3NhZ2U+ID0+IHtcbiAgICBjb25zdCB0eXBlZERhdGEgPSB7XG4gICAgICAgIHR5cGVzOiB7XG4gICAgICAgICAgICBFSVA3MTJEb21haW4sXG4gICAgICAgICAgICBCb29zdGVkTWVyZ2UsXG4gICAgICAgICAgICBCb29zdGVyRnVlbCxcbiAgICAgICAgICAgIEJvb3N0ZXJQYXlsb2FkLFxuICAgICAgICB9IGFzIGFueSxcbiAgICAgICAgZG9tYWluOiBjcmVhdGVFSVA3MTJEb21haW4oXCJDbGFzaCBPZiBTdHJlYW1lcnNcIiwgdmVyaWZ5aW5nQ29udHJhY3QpLFxuICAgICAgICBwcmltYXJ5VHlwZTogXCJCb29zdGVkTWVyZ2VcIixcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgICAgdGFnOiBCb29zdFRhZy5NZXJnZSxcbiAgICAgICAgICAgIHRva2VuSWRTb3VyY2U6IHRva2VuSWRTb3VyY2UudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIHRva2VuSWRUYXJnZXQ6IHRva2VuSWRUYXJnZXQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIGZ1ZWw6IHtcbiAgICAgICAgICAgICAgICBkdWJpOiAoZnVlbD8uZHViaSA/PyAwKS50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgIHVubG9ja2VkUHJwczogKGZ1ZWw/LnVubG9ja2VkUHJwcyA/PyAwKS50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgIGxvY2tlZFBycHM6IChmdWVsPy5sb2NrZWRQcnBzID8/IDApLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgaW50cmluc2ljRnVlbDogKGZ1ZWw/LmludHJpbnNpY0Z1ZWwgPz8gMCkudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBib29zdGVyUGF5bG9hZDoge1xuICAgICAgICAgICAgICAgIGJvb3N0ZXIsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAgPz8gYXdhaXQgYmxvY2tjaGFpblRpbWVzdGFtcFdpdGhPZmZzZXQod2ViMywgMCksXG4gICAgICAgICAgICAgICAgbm9uY2U6IG5vbmNlLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgaXNMZWdhY3lTaWduYXR1cmU6IChpc0xlZ2FjeVNpZ25hdHVyZSB8fCBmYWxzZSksXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgbWVzc2FnZTogdHlwZWREYXRhLm1lc3NhZ2UsXG4gICAgICAgIHNpZ25hdHVyZTogc2lnbkVJUDcxMih0eXBlZERhdGEsIHsgcHJpdmF0ZUtleSB9KSxcbiAgICAgICAgbWVzc2FnZUJ5dGVzOiBnZXRUeXBlZE1lc3NhZ2VCeXRlcyh3ZWIzLCB0eXBlZERhdGEpLFxuICAgICAgICBtZXNzYWdlSGFzaDogYDB4JHtUeXBlZERhdGFVdGlscy5zaWduKHR5cGVkRGF0YSkudG9TdHJpbmcoXCJoZXhcIil9YCxcbiAgICB9O1xufVxuXG5leHBvcnQgY29uc3QgY3JlYXRlU2lnbmVkQm9vc3RlZEtpbGxNZXNzYWdlID0gYXN5bmMgKHdlYjMsIHsgdG9rZW5JZCwgbm9uY2UsIHRpbWVzdGFtcCwgZnVlbCwgYm9vc3RlciwgaXNMZWdhY3lTaWduYXR1cmUsIHZlcmlmeWluZ0NvbnRyYWN0LCBzaWduZXI6IHsgcHJpdmF0ZUtleSB9IH06IHsgdG9rZW5JZDogc3RyaW5nOyBub25jZTogQk47IHRpbWVzdGFtcD86IG51bWJlciwgaXNMZWdhY3lTaWduYXR1cmU/OiBib29sZWFuOyBmdWVsPzogeyBkdWJpPzogQk4sIHVubG9ja2VkUHJwcz86IEJOLCBsb2NrZWRQcnBzPzogQk4sIGludHJpbnNpY0Z1ZWw/OiBCTiB9LCBib29zdGVyOiBzdHJpbmcsIHZlcmlmeWluZ0NvbnRyYWN0OiBzdHJpbmcsIHNpZ25lcjogeyBwcml2YXRlS2V5OiBzdHJpbmcgfTsgfSk6IFByb21pc2U8RUlQNzEyU2lnbmVkTWVzc2FnZT4gPT4ge1xuICAgIGNvbnN0IHR5cGVkRGF0YSA9IHtcbiAgICAgICAgdHlwZXM6IHtcbiAgICAgICAgICAgIEVJUDcxMkRvbWFpbixcbiAgICAgICAgICAgIEJvb3N0ZWRLaWxsLFxuICAgICAgICAgICAgQm9vc3RlckZ1ZWwsXG4gICAgICAgICAgICBCb29zdGVyUGF5bG9hZCxcbiAgICAgICAgfSBhcyBhbnksXG4gICAgICAgIGRvbWFpbjogY3JlYXRlRUlQNzEyRG9tYWluKFwiQ2xhc2ggT2YgU3RyZWFtZXJzXCIsIHZlcmlmeWluZ0NvbnRyYWN0KSxcbiAgICAgICAgcHJpbWFyeVR5cGU6IFwiQm9vc3RlZEtpbGxcIixcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgICAgdGFnOiBCb29zdFRhZy5LaWxsLFxuICAgICAgICAgICAgdG9rZW5JZDogdG9rZW5JZC50b1N0cmluZygpLFxuICAgICAgICAgICAgZnVlbDoge1xuICAgICAgICAgICAgICAgIGR1Ymk6IChmdWVsPy5kdWJpID8/IDApLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgdW5sb2NrZWRQcnBzOiAoZnVlbD8udW5sb2NrZWRQcnBzID8/IDApLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgbG9ja2VkUHJwczogKGZ1ZWw/LmxvY2tlZFBycHMgPz8gMCkudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICBpbnRyaW5zaWNGdWVsOiAoZnVlbD8uaW50cmluc2ljRnVlbCA/PyAwKS50b1N0cmluZygpLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJvb3N0ZXJQYXlsb2FkOiB7XG4gICAgICAgICAgICAgICAgYm9vc3RlcixcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IHRpbWVzdGFtcCA/PyBhd2FpdCBibG9ja2NoYWluVGltZXN0YW1wV2l0aE9mZnNldCh3ZWIzLCAwKSxcbiAgICAgICAgICAgICAgICBub25jZTogbm9uY2UudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICBpc0xlZ2FjeVNpZ25hdHVyZTogKGlzTGVnYWN5U2lnbmF0dXJlIHx8IGZhbHNlKSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBtZXNzYWdlOiB0eXBlZERhdGEubWVzc2FnZSxcbiAgICAgICAgc2lnbmF0dXJlOiBzaWduRUlQNzEyKHR5cGVkRGF0YSwgeyBwcml2YXRlS2V5IH0pLFxuICAgICAgICBtZXNzYWdlQnl0ZXM6IGdldFR5cGVkTWVzc2FnZUJ5dGVzKHdlYjMsIHR5cGVkRGF0YSksXG4gICAgICAgIG1lc3NhZ2VIYXNoOiBgMHgke1R5cGVkRGF0YVV0aWxzLnNpZ24odHlwZWREYXRhKS50b1N0cmluZyhcImhleFwiKX1gLFxuICAgIH07XG59XG5cbmV4cG9ydCBjb25zdCBtb2NrSGVyb0F0dHJpYnV0ZXMgPSAoYXR0cmlidXRlcz86IFJlY29yZDxzdHJpbmcsIGFueT4pOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0+ICh7IC4uLmhlcm9BdHRyaWJ1dGVzLCAuLi5hdHRyaWJ1dGVzIH0pO1xuZXhwb3J0IGNvbnN0IG1vY2tQZXRBdHRyaWJ1dGVzID0gKGF0dHJpYnV0ZXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUmVjb3JkPHN0cmluZywgYW55PiA9PiAoeyAuLi5wZXRBdHRyaWJ1dGVzLCAuLi5hdHRyaWJ1dGVzIH0pO1xuXG5leHBvcnQgY29uc3QgbW9ja0F0dHJpYnV0ZXMgPSAoYXR0cmlidXRlcz86IHt9KTogUmVjb3JkPHN0cmluZywgYW55PiA9PiAoeyAuLi5kZWZhdWx0QXR0cmlidXRlcywgLi4uYXR0cmlidXRlcyB9KTtcblxuZXhwb3J0IGNvbnN0IHRvTnVtYmVySGV4ID0gKGlucHV0OiBudW1iZXIpOiBzdHJpbmcgPT4gYDB4JHtpbnB1dC50b1N0cmluZygxNikucGFkU3RhcnQoNjQsIFwiMFwiKX1gO1xuZXhwb3J0IGNvbnN0IHRvU3RyaW5nSGV4ID0gKGlucHV0OiBzdHJpbmcpOiBzdHJpbmcgPT4gYDB4JHtCdWZmZXIuZnJvbShpbnB1dCkudG9TdHJpbmcoXCJoZXhcIikucGFkRW5kKDY0LCBcIjBcIil9YDtcblxuZXhwb3J0IGNvbnN0IG1vY2tFeHRyYUF0dHJpYnV0ZXMgPSAoYXR0cmlidXRlcz86IHt9KTogeyBrZXlzOiBzdHJpbmdbXSwgdmFsdWVzOiAoc3RyaW5nIHwgbnVtYmVyKVtdIH0gPT4ge1xuICAgIGNvbnN0IGtleXM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgdmFsdWVzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHsgLi4uZGVmYXVsdEF0dHJpYnV0ZXMsIC4uLmF0dHJpYnV0ZXMgfSkpIHtcbiAgICAgICAga2V5cy5wdXNoKHRvU3RyaW5nSGV4KGtleSkpO1xuICAgICAgICB2YWx1ZXMucHVzaCh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIgPyB0b1N0cmluZ0hleCh2YWx1ZSkgOiB0b051bWJlckhleCh2YWx1ZSkpXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAga2V5cyxcbiAgICAgICAgdmFsdWVzLFxuICAgIH1cbn1cblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRBdHRyaWJ1dGVzID0ge1xuICAgIGxldmVsOiAxLFxuICAgIHN0YXJzOiAyLFxuICAgIGZhY3Rpb246IDMsXG4gICAgYWJpbGl0aWVzOiAxMjM0LFxuICAgIHNlYXNvbjogOSxcbn1cblxuZXhwb3J0IGNvbnN0IGhlcm9BdHRyaWJ1dGVzID0ge1xuICAgIC4uLmRlZmF1bHRBdHRyaWJ1dGVzLFxuICAgIGhlYWRJZEFsaWFzOiBcIjg4XCIsXG4gICAgc2tpblNsb3Q6IDEsXG4gICAgc2tpbkRpdmlzaW9uOiAxMixcbiAgICBjbGFzczogMyxcbn1cblxuZXhwb3J0IGNvbnN0IHBldEF0dHJpYnV0ZXMgPSB7XG4gICAgLi4uZGVmYXVsdEF0dHJpYnV0ZXMsXG4gICAgaGVhZElkQWxpYXM6IFwiMTIzXCIsXG4gICAgc2hpbnlIdWU6IDI1NSxcbn1cblxuZXhwb3J0IGNvbnN0IHBhY2tDb2xsZWN0aWJsZURhdGEgPSAoY29udHJhY3QsIGRlcGxveW1lbnQsIGF0dHJpYnV0ZXMpID0+IHtcblxuICAgIC8vIFdlIG5lZWQgdG8gcGFjayB0aGUgYXR0cmlidXRlcyBpbnRvIGEgdWludDI1NlxuICAgIGNvbnN0IHBhY2tlZERhdGEgPSBuZXcgQk4oMCk7XG4gICAgbGV0IG9mZnNldCA9IDA7XG4gICAgLy8gMjQgYml0IGhlYWRJZFxuICAgIHBhY2tlZERhdGEuaW9yKG5ldyBCTihhdHRyaWJ1dGVzLmhlYWRJZEFsaWFzKSlcbiAgICBvZmZzZXQgKz0gMjQ7XG4gICAgLy8gOTYgYml0IGVtcG93ZXJlZERVQklcbiAgICBwYWNrZWREYXRhLmlvcihuZXcgQk4oYXR0cmlidXRlcy5lbXBvd2VyZWREVUJJKS5zaGxuKG9mZnNldCkpO1xuICAgIG9mZnNldCArPSA5NjtcbiAgICAvLyAzMiBiaXQgc2Vhc29uXG4gICAgcGFja2VkRGF0YS5pb3IobmV3IEJOKGF0dHJpYnV0ZXMuc2Vhc29uKS5zaGxuKG9mZnNldCkpO1xuICAgIG9mZnNldCArPSAzMjtcbiAgICAvLyAzMiBiaXQgYWJpbGl0aWVzXG4gICAgcGFja2VkRGF0YS5pb3IobmV3IEJOKGF0dHJpYnV0ZXMuYWJpbGl0aWVzKS5zaGxuKG9mZnNldCkpO1xuICAgIG9mZnNldCArPSAzMjtcbiAgICAvLyA4IGJpdCBzdGFyc1xuICAgIHBhY2tlZERhdGEuaW9yKG5ldyBCTihhdHRyaWJ1dGVzLnN0YXJzKS5zaGxuKG9mZnNldCkpO1xuICAgIG9mZnNldCArPSA4O1xuICAgIC8vIDggYml0IGxldmVsXG4gICAgcGFja2VkRGF0YS5pb3IobmV3IEJOKGF0dHJpYnV0ZXMubGV2ZWwpLnNobG4ob2Zmc2V0KSk7XG4gICAgb2Zmc2V0ICs9IDg7XG4gICAgLy8gNCBiaXQgZmFjdGlvblxuICAgIC8vIFNpbmNlIGl0IGlzIHN0b3JlZCBpbiBhIHVpbnQ4IEFORCBpdCB3aXRoIGEgYml0bWFzayB3aGVyZSB0aGUgZmlyc3QgNCBiaXRzIGFyZSAxXG4gICAgcGFja2VkRGF0YS5pb3IobmV3IEJOKGF0dHJpYnV0ZXMuZmFjdGlvbikuc2hsbihvZmZzZXQpKTtcbiAgICBvZmZzZXQgKz0gNDtcblxuICAgIC8vIFNraXAgMiBiaXRzIGZvciB0aGUgZmxhZ3Mgd2hpY2ggYXJlIDAgYnkgZGVmYXVsdFxuICAgIGlmIChhdHRyaWJ1dGVzLmlzRnJhdWQpIHtcbiAgICAgICAgcGFja2VkRGF0YS5pb3IobmV3IEJOKDEpLnNobG4ob2Zmc2V0ICsgMCkpXG4gICAgfVxuICAgIGlmIChhdHRyaWJ1dGVzLmhhc0RlcGVuZGVudE9wKSB7XG4gICAgICAgIHBhY2tlZERhdGEuaW9yKG5ldyBCTigxKS5zaGxuKG9mZnNldCArIDEpKVxuICAgIH1cbiAgICBvZmZzZXQgKz0gMjtcblxuICAgIGlmIChjb250cmFjdC5hZGRyZXNzID09PSBkZXBsb3ltZW50Lkhlcm9lcy5hZGRyZXNzKSB7XG4gICAgICAgIC8vIDI0IGJpdCBza2luRHZpc2lvblxuICAgICAgICBwYWNrZWREYXRhLmlvcihuZXcgQk4oYXR0cmlidXRlcy5za2luRGl2aXNpb24pLnNobG4ob2Zmc2V0KSk7XG4gICAgICAgIG9mZnNldCArPSAyNDtcbiAgICAgICAgLy8gMTYgYml0IHNraW5TbG90XG4gICAgICAgIHBhY2tlZERhdGEuaW9yKG5ldyBCTihhdHRyaWJ1dGVzLnNraW5TbG90KS5zaGxuKG9mZnNldCkpO1xuICAgICAgICBvZmZzZXQgKz0gMTY7XG4gICAgICAgIC8vIDQgYml0IGNsYXNzXG4gICAgICAgIHBhY2tlZERhdGEuaW9yKG5ldyBCTihhdHRyaWJ1dGVzLmNsYXNzKS5zaGxuKG9mZnNldCkpO1xuICAgICAgICBvZmZzZXQgKz0gNDtcbiAgICB9IGVsc2Uge1xuICAgICAgICAvLyA4IGJpdCBzaGlueUh1ZVxuICAgICAgICBwYWNrZWREYXRhLmlvcihuZXcgQk4oYXR0cmlidXRlcy5zaGlueUh1ZSkuc2hsbihvZmZzZXQpKTtcbiAgICAgICAgb2Zmc2V0ICs9IDg7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhY2tlZERhdGE7XG59XG4iXX0=